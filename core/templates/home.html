{% extends 'base.html' %}

{% block content %}
<div class="flex h-full w-full">

    <aside class="w-80 bg-black border-r border-red-900 flex flex-col z-20 shadow-2xl">
        
        <div class="p-5 border-b border-red-900/50 bg-dark-100">
            <h3 class="text-xl text-red-500 font-stranger mb-3 tracking-widest">Friends List</h3>
            <input type="text" 
                   placeholder="SEARCH RECORDS..." 
                   class="w-full bg-black border border-red-800 text-red-400 placeholder-red-900 px-3 py-2 text-sm focus:outline-none focus:border-red-500 transition uppercase">
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-hide">
            
            <div class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border border-transparent hover:border-red-900 transition group">
                <div class="w-8 h-8 bg-red-900 rounded-full flex items-center justify-center text-xs text-white font-bold">
                    W
                </div>
                <div class="ml-3">
                    <p class="text-red-300 font-bold text-sm group-hover:text-white transition">Will Byers</p>
                    <p class="text-xs text-green-600 font-mono uppercase">Online</p>
                </div>
            </div>

            <div class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border border-transparent hover:border-red-900 transition group">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center text-xs text-gray-500 font-bold">
                    M
                </div>
                <div class="ml-3">
                    <p class="text-gray-500 font-bold text-sm group-hover:text-gray-300 transition">Mike Wheeler</p>
                    <p class="text-xs text-gray-600 font-mono uppercase">Offline</p>
                </div>
            </div>

            <div class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border border-transparent hover:border-red-900 transition group">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center text-xs text-gray-500 font-bold">
                    E
                </div>
                <div class="ml-3">
                    <p class="text-gray-500 font-bold text-sm group-hover:text-gray-300 transition">Eleven</p>
                    <p class="text-xs text-gray-600 font-mono uppercase">Offline</p>
                </div>
            </div>

        </div>
    </aside>

    <main class="flex-1 flex flex-col items-center justify-center bg-[#1a1a1a] relative overflow-hidden">
    
    <div class="absolute inset-0 opacity-30" style="background: radial-gradient(circle at 50% 50%, #2d2d2d 0%, #000000 100%);"></div>

    <div class="relative mt-24 z-10 group transform transition duration-500 hover:scale-[1.02]">
        
        <div id="radio-antenna" 
             class="absolute bottom-[98%] left-8 w-4 h-6 bg-gradient-to-r from-gray-300 via-white to-gray-400 border border-gray-600 rounded-t-full transition-all duration-1000 ease-in-out z-0 shadow-lg">
             <div class="absolute -top-1 left-0 w-full h-2 bg-red-600 rounded-t-full border-b border-red-800"></div>
             <div class="absolute top-1/3 w-full h-[1px] bg-gray-400"></div>
             <div class="absolute top-2/3 w-full h-[1px] bg-gray-400"></div>
        </div>

        <div class="relative w-80 bg-gradient-to-b from-gray-700 to-gray-900 rounded-[2.5rem] p-1 shadow-[0_20px_50px_rgba(0,0,0,0.8),inset_0_1px_1px_rgba(255,255,255,0.2)] border border-gray-950">
            
            <div class="absolute inset-0 rounded-[2.5rem] opacity-20 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/leather.png');"></div>

            <div class="h-16 bg-[#111] rounded-t-[2rem] rounded-b-lg mb-4 flex items-center justify-between px-6 border-b border-gray-600 shadow-md relative">
                <div class="flex flex-col items-center">
                    <div class="w-10 h-6 bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 rounded-sm border border-black shadow-[0_2px_4px_black]"></div>
                    <span class="text-[8px] text-gray-400 font-bold mt-1 tracking-widest">VOL</span>
                </div>
                <div class="text-xs font-bold text-gray-500 tracking-[0.2em] border border-gray-600 px-2 py-0.5 rounded bg-[#1a1a1a]">
                    REALISTIC
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-10 h-6 bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 rounded-sm border border-black shadow-[0_2px_4px_black]"></div>
                    <span class="text-[8px] text-gray-400 font-bold mt-1 tracking-widest">SQL</span>
                </div>
            </div>

            <div class="mx-auto w-64 h-32 bg-[#0a0a0a] rounded-xl mb-6 relative border-2 border-gray-800 shadow-[inset_0_0_10px_black]">
                <div class="absolute inset-0 opacity-80" 
                     style="background-image: radial-gradient(#333 1.5px, transparent 1.5px); background-size: 6px 6px; background-position: 0 0, 3px 3px;">
                </div>
                <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white to-transparent opacity-5 rounded-t-xl"></div>
            </div>

            <div class="mx-auto w-64 h-24 bg-[#7a852d] rounded shadow-[inset_0_0_15px_rgba(0,0,0,0.6)] border-4 border-gray-600 mb-6 relative overflow-hidden flex flex-col items-center justify-center">
                <div class="absolute top-0 right-0 w-32 h-full bg-gradient-to-l from-white to-transparent opacity-10 transform skew-x-12"></div>
                
                <h2 id="radio-name" class="font-mono text-xl font-bold text-[#1a1f03] tracking-widest z-10 uppercase drop-shadow-sm">
                    --STANDBY--
                </h2>
                <div class="flex items-center space-x-2 z-10 mt-1">
                    <span class="text-[9px] font-bold text-[#2f350b]">CH:</span>
                    <span id="radio-channel" class="font-mono text-2xl font-bold text-[#1a1f03]">00</span>
                </div>
            </div>

            <div class="px-4 pb-6">
                <button id="radio-btn" 
                        class="relative w-full h-16 bg-gradient-to-b from-gray-700 to-gray-800 rounded-lg shadow-[0_5px_0_#1f2937,0_10px_10px_rgba(0,0,0,0.5)] active:shadow-none active:translate-y-[5px] active:border-t-4 active:border-black transition-all border-t border-gray-600 group-hover:from-gray-600 group-hover:to-gray-700">
                    
                    <span class="text-gray-300 font-bold tracking-[0.2em] uppercase text-sm drop-shadow-md">
                        PUSH TO SCAN
                    </span>

                    <div class="absolute left-2 top-1/2 -translate-y-1/2 w-4 h-8 flex flex-col gap-1 opacity-30">
                        <div class="h-0.5 bg-black w-full"></div>
                        <div class="h-0.5 bg-black w-full"></div>
                        <div class="h-0.5 bg-black w-full"></div>
                    </div>
                </button>
            </div>

            <div class="absolute bottom-4 left-6 w-3 h-3 bg-gray-800 rounded-full flex items-center justify-center shadow-[inset_0_1px_2px_black]"><div class="w-full h-[1px] bg-gray-600 rotate-45"></div></div>
            <div class="absolute bottom-4 right-6 w-3 h-3 bg-gray-800 rounded-full flex items-center justify-center shadow-[inset_0_1px_2px_black]"><div class="w-full h-[1px] bg-gray-600 rotate-45"></div></div>

        </div>
        
        <div class="absolute top-8 -right-4 w-4 h-full bg-black opacity-40 blur-lg -z-10 rounded-full"></div>

    </div>

</main>


    

</div>
<script>
    const searchInput = document.querySelector('input[type="text"]');
    let debounceTimeout;
    searchInput.addEventListener('input', function(e){
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const query = e.target.value;
            console.log("searching for : ", query);
            fetchUsers(query);
        }, 500);
    });

    function fetchUsers(query){
        fetch(`/api/search/?q=${query}`)
            .then(response => {
                if( !response.ok){
                    throw new Error("Network response was not ohk.");
                }
                return response.json();
            })
            .then(data => {
                console.log("Received Data : ", data)
                renderSidebar(data);
            })
            .catch(error => {
                console.log("Error : ", error );
            });
    }

    const sidebarList = document.querySelector('.overflow-y-auto');
    function renderSidebar(users) {
        sidebarList.innerHTML = ''; // Clear old results

        if (users.length === 0) {
            sidebarList.innerHTML = '<div class="p-4 text-red-500 font-mono text-xs text-center">NO SIGNALS FOUND IN RANGE</div>';
            return;
        }

        users.forEach(user => {
            // Determine if they are already a friend
            const isFriend = user.friendship_status === 'accepted';
            
            // Template Literal for the List Item
            const html = `
                <div onclick="updateRadio('${user.username}', ${user.friend_count}, '${user.friendship_status}', ${user.id})"
                    class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border-b border-red-900/30 transition group">
                    
                    <div class="w-8 h-8 bg-gray-800 text-red-500 border border-red-800 rounded flex items-center justify-center font-mono text-xs font-bold">
                        ${user.username.substring(0,2).toUpperCase()}
                    </div>
                    
                    <div class="ml-3">
                        <p class="text-red-400 font-mono text-sm group-hover:text-red-300">${user.username}</p>
                        <p class="text-[10px] text-gray-500 font-mono uppercase">CH ${user.friend_count}</p>
                    </div>
                </div>
            `;
            sidebarList.insertAdjacentHTML('beforeend', html);
        });
    }

    // DOM Elements for the Radio
    const radioName = document.getElementById('radio-name');
    const radioChannel = document.getElementById('radio-channel');
    const radioAntenna = document.getElementById('radio-antenna');
    const radioBtn = document.getElementById('radio-btn');

    function updateRadio(username, count, status, userId) {
        // 1. Update Screen Text
        radioName.innerText = username.toUpperCase();
        radioChannel.innerText = count.toString().padStart(2, '0'); // Turns 5 into 05

        // 2. ANTENNA LOGIC (Inflated vs Not Inflated)
        if (status === 'accepted') {
            // Friends: Extend Antenna fully
            radioAntenna.style.height = "240px"; // Tall
            radioAntenna.classList.remove('bg-gray-400');
            radioAntenna.classList.add('bg-green-400'); // Signal Green
        } else {
            // Strangers: Retract Antenna
            radioAntenna.style.height = "24px"; // Short
            radioAntenna.classList.remove('bg-green-400');
            radioAntenna.classList.add('bg-gray-400');
        }

        // 3. BUTTON LOGIC (Get on same Channel)
        configureRadioButton(status, userId);
    }

    function configureRadioButton(status, userId) {
        // Reset basic styles
        radioBtn.onclick = null;
        
        if (status === 'none') {
            radioBtn.innerText = "GET ON SAME CHANNEL"; // Send Request
            radioBtn.className = "w-full h-16 bg-red-900 text-red-200 font-bold tracking-widest uppercase hover:bg-red-800 border-b-4 border-red-950 active:border-b-0 active:translate-y-1 transition rounded-lg";
            // Add click event later for API call
        } 
        else if (status === 'accepted') {
            radioBtn.innerText = "OPEN COMMS"; // Already Friends
            radioBtn.className = "w-full h-16 bg-green-800 text-green-100 font-bold tracking-widest uppercase hover:bg-green-700 border-b-4 border-green-950 active:border-b-0 active:translate-y-1 transition rounded-lg";
        }
        else if (status === 'sent') {
            radioBtn.innerText = "TUNING..."; // Pending
            radioBtn.className = "w-full h-16 bg-yellow-800 text-yellow-100 font-bold tracking-widest uppercase cursor-wait border-b-4 border-yellow-950 rounded-lg";
        }
        else if (status === 'self') {
            radioBtn.innerText = "TEST PATTERN";
            radioBtn.className = "w-full h-16 bg-gray-700 text-gray-500 cursor-not-allowed border-b-4 border-gray-900 rounded-lg";
        }
    }
</script>
{% endblock %}