{% extends 'base.html' %}

{% block content %}
<div class="flex h-full w-full">

    <aside class="w-80 bg-black border-r border-red-900 flex flex-col z-20 shadow-2xl">
        
        <div class="p-5 border-b border-red-900/50 bg-dark-100">
            <h3 class="text-xl text-red-500 font-stranger mb-3 tracking-widest">Friends List</h3>
            <input type="text" 
                   placeholder="SEARCH RECORDS..." 
                   class="w-full bg-black border border-red-800 text-red-400 placeholder-red-900 px-3 py-2 text-sm focus:outline-none focus:border-red-500 transition uppercase">
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-hide">
            
            {% comment %} <div class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border border-transparent hover:border-red-900 transition group">
                <div class="w-8 h-8 bg-red-900 rounded-full flex items-center justify-center text-xs text-white font-bold">
                    W
                </div>
                <div class="ml-3">
                    <p class="text-red-300 font-bold text-sm group-hover:text-white transition">Will Byers</p>
                    <p class="text-xs text-green-600 font-mono uppercase">Online</p>
                </div>
            </div>

            <div class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border border-transparent hover:border-red-900 transition group">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center text-xs text-gray-500 font-bold">
                    M
                </div>
                <div class="ml-3">
                    <p class="text-gray-500 font-bold text-sm group-hover:text-gray-300 transition">Mike Wheeler</p>
                    <p class="text-xs text-gray-600 font-mono uppercase">Offline</p>
                </div>
            </div>

            <div class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border border-transparent hover:border-red-900 transition group">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center text-xs text-gray-500 font-bold">
                    E
                </div>
                <div class="ml-3">
                    <p class="text-gray-500 font-bold text-sm group-hover:text-gray-300 transition">Eleven</p>
                    <p class="text-xs text-gray-600 font-mono uppercase">Offline</p>
                </div>
            </div> {% endcomment %}

        </div>
    </aside>

    <main class="flex-1 flex flex-col items-center justify-center bg-[#1a1a1a] relative overflow-hidden">
    
    <div class="absolute inset-0 opacity-30" style="background: radial-gradient(circle at 50% 50%, #2d2d2d 0%, #000000 100%);"></div>

    <div class="relative mt-24 z-10 group transform transition duration-500 hover:scale-[1.02]">
        
        <div id="radio-antenna" 
             class="absolute bottom-[98%] left-8 w-4 h-6 bg-gradient-to-r from-gray-300 via-white to-gray-400 border border-gray-600 rounded-t-full transition-all duration-1000 ease-in-out z-0 shadow-lg">
             <div id="radio-antenna-tip" class="absolute -top-1 left-0 w-full h-2 bg-red-600 rounded-t-full border-b border-red-800 transition-colors duration-500 shadow-[0_0_5px_rgba(220,38,38,0.8)]"></div>
             <div class="absolute top-1/3 w-full h-[1px] bg-gray-400"></div>
             <div class="absolute top-2/3 w-full h-[1px] bg-gray-400"></div>
        </div>

        <div class="relative w-80 bg-gradient-to-b from-gray-700 to-gray-900 rounded-[2.5rem] p-1 shadow-[0_20px_50px_rgba(0,0,0,0.8),inset_0_1px_1px_rgba(255,255,255,0.2)] border border-gray-950">
            
            <div class="absolute inset-0 rounded-[2.5rem] opacity-20 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/leather.png');"></div>

            <div class="h-16 bg-[#111] rounded-t-[2rem] rounded-b-lg mb-4 flex items-center justify-between px-6 border-b border-gray-600 shadow-md relative">
                <div class="flex flex-col items-center">
                    <div class="w-10 h-6 bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 rounded-sm border border-black shadow-[0_2px_4px_black]"></div>
                    <span class="text-[8px] text-gray-400 font-bold mt-1 tracking-widest">VOL</span>
                </div>
                <div class="text-xs font-bold text-gray-500 tracking-[0.2em] border border-gray-600 px-2 py-0.5 rounded bg-[#1a1a1a]">
                    REALISTIC
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-10 h-6 bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 rounded-sm border border-black shadow-[0_2px_4px_black]"></div>
                    <span class="text-[8px] text-gray-400 font-bold mt-1 tracking-widest">SQL</span>
                </div>
            </div>

            <div class="mx-auto w-64 h-32 bg-[#0a0a0a] rounded-xl mb-6 relative border-2 border-gray-800 shadow-[inset_0_0_10px_black]">
                <div class="absolute inset-0 opacity-80" 
                     style="background-image: radial-gradient(#333 1.5px, transparent 1.5px); background-size: 6px 6px; background-position: 0 0, 3px 3px;">
                </div>
                <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white to-transparent opacity-5 rounded-t-xl"></div>
            </div>

            <div class="mx-auto w-64 h-35 bg-[#7a852d] rounded shadow-[inset_0_0_15px_rgba(0,0,0,0.6)] border-4 border-gray-600 mb-6 relative overflow-hidden flex flex-col items-center justify-center">
                <div class="absolute top-0 right-0 w-32 h-full bg-gradient-to-l from-white to-transparent opacity-10 transform skew-x-12"></div>
                
                <h2 id="radio-name" class="font-mono text-xl font-bold text-[#1a1f03] tracking-widest z-10 uppercase drop-shadow-sm">
                    --STANDBY--
                </h2>
                <div class="flex items-center space-x-2 z-10 mt-1">
                    <span class="text-[9px] font-bold text-[#2f350b]">FREQ:</span> <span id="radio-frequency" class="font-mono text-2xl font-bold text-[#1a1f03]">00.0</span>
                </div>
                <div class="flex items-center space-x-2 z-10 mt-1">
                    <span class="text-[9px] font-bold text-[#2f350b]">CH:</span>
                    <span id="radio-channel" class="font-mono text-2xl font-bold text-[#1a1f03]">00</span>
                </div>
            </div>

            <div class="px-4 pb-6 flex flex-col gap-3">
    
                <button id="radio-btn" 
                        class="relative w-full h-16 bg-gradient-to-b from-gray-700 to-gray-800 rounded-lg shadow-[0_5px_0_#1f2937,0_10px_10px_rgba(0,0,0,0.5)] active:shadow-none active:translate-y-[5px] active:border-t-4 active:border-black transition-all border-t border-gray-600 group-hover:from-gray-600 group-hover:to-gray-700">
                    <span id="radio-btn-text" class="text-gray-300 font-bold tracking-[0.2em] uppercase text-sm drop-shadow-md">
                        PUSH TO SCAN
                    </span>
                </button>

                <div id="dimension-controls" class="hidden flex gap-3 w-full">
                    
                    <button id="btn-hawkins" class="w-1/2 h-16 bg-[#1a2d45] border-2 border-blue-900 rounded-lg shadow-[0_0_15px_rgba(30,144,255,0.2)] hover:bg-[#233b59] hover:border-blue-500 hover:shadow-[0_0_25px_rgba(30,144,255,0.6)] transition-all group flex flex-col items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-blue-500 opacity-0 group-hover:opacity-10 transition-opacity"></div>
                        <span class="text-blue-100 font-mono text-[10px] tracking-widest uppercase z-10">TUNE:</span>
                        <span class="text-blue-400 font-bold font-mono text-sm tracking-widest uppercase z-10">REALITY</span>
                    </button>

                    <button id="btn-upsidedown" class="w-1/2 h-16 bg-[#2d0a0a] border-2 border-red-900 rounded-lg shadow-[0_0_15px_rgba(255,0,0,0.2)] hover:bg-[#450e0e] hover:border-red-600 hover:shadow-[0_0_25px_rgba(255,0,0,0.6)] transition-all group flex flex-col items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30 animate-pulse"></div>
                        <span class="text-red-100 font-mono text-[10px] tracking-widest uppercase z-10">ENTER:</span>
                        <span class="text-red-500 font-bold font-stranger text-sm tracking-widest uppercase z-10" style="text-shadow: 0 0 5px red;">THE RIFT</span>
                    </button>

                </div>

                <button id="reject-btn" 
                        class="hidden w-full h-10 bg-red-950 border border-red-700 text-red-500 font-mono text-xs uppercase tracking-widest hover:bg-red-900 hover:text-red-200 transition rounded shadow-[inset_0_0_10px_black]">
                    CUT SIGNAL (REJECT)
                </button>
            </div>

            <div class="absolute bottom-4 left-6 w-3 h-3 bg-gray-800 rounded-full flex items-center justify-center shadow-[inset_0_1px_2px_black]"><div class="w-full h-[1px] bg-gray-600 rotate-45"></div></div>
            <div class="absolute bottom-4 right-6 w-3 h-3 bg-gray-800 rounded-full flex items-center justify-center shadow-[inset_0_1px_2px_black]"><div class="w-full h-[1px] bg-gray-600 rotate-45"></div></div>

        </div>
        
        <div class="absolute top-8 -right-4 w-4 h-full bg-black opacity-40 blur-lg -z-10 rounded-full"></div>

    </div>

</main>


    

</div>
<script>
    const searchInput = document.querySelector('input[type="text"]');
    let debounceTimeout;
    searchInput.addEventListener('input', function(e){
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const query = e.target.value;
            console.log("searching for : ", query);
            fetchUsers(query);
        }, 500);
    });

    function fetchUsers(query){
        fetch(`/api/search/?q=${query}`)
            .then(response => {
                if( !response.ok){
                    throw new Error("Network response was not ohk.");
                }
                return response.json();
            })
            .then(data => {
                console.log("Received Data : ", data)
                renderSidebar(data);
            })
            .catch(error => {
                console.log("Error : ", error );
            });
    }

    const sidebarList = document.querySelector('.overflow-y-auto');
    function renderSidebar(users) {
        sidebarList.innerHTML = ''; // Clear old results

        if (users.length === 0) {
            sidebarList.innerHTML = '<div class="p-4 text-red-500 font-mono text-xs text-center">NO SIGNALS FOUND IN RANGE</div>';
            return;
        }

        users.forEach(user => {
            // Determine if they are already a friend
            const isFriend = user.friendship_status === 'accepted';
            
            // Template Literal for the List Item
            const html = `
                <div onclick="updateRadio('${user.username}', '${user.frequency}', ${user.friend_count}, ${user.friendship_status}, ${user.id})"
                    class="flex items-center p-3 cursor-pointer hover:bg-red-900/20 border-b border-red-900/30 transition group">
                    
                    <div class="w-8 h-8 bg-gray-800 text-red-500 border border-red-800 rounded flex items-center justify-center font-mono text-xs font-bold">
                        ${user.username.substring(0,2).toUpperCase()}
                    </div>
                    
                    <div class="ml-3">
                        <p class="text-red-400 font-mono text-sm group-hover:text-red-300">${user.username}</p>
                        <p class="text-[10px] text-gray-500 font-mono uppercase">CH ${user.friend_count}</p>
                        <p class="text-[10px] text-gray-500 font-mono uppercase">FREQ: ${user.frequency}</p>
                    </div>
                </div>
            `;
            sidebarList.insertAdjacentHTML('beforeend', html);
        });
    }

    // DOM Elements for the Radio
    const radioName = document.getElementById('radio-name');
    const radioChannel = document.getElementById('radio-channel');
    const radioFrequency = document.getElementById('radio-frequency');
    const radioAntenna = document.getElementById('radio-antenna');
    const radioBtn = document.getElementById('radio-btn');
    const radioAntennaTip = document.getElementById('radio-antenna-tip');

    let currentSelectedId = null;
    let currentFrequency = null;

    function updateRadio(username, freq, count, status, userId) {
        currentSelectedId = userId;
        currentFrequency = freq;
        status = Number(status);
        // 1. Update Screen Text
        radioName.innerText = username.toUpperCase();
        radioChannel.innerText = count.toString().padStart(2, '0'); // Turns 5 into 05
        radioFrequency.innerText = freq;

        // 2. ANTENNA LOGIC (Inflated vs Not Inflated)
        if (status === 2) {
            // Friends: Extend Antenna fully
            radioAntenna.style.height = "240px"; // Tall
            radioAntenna.classList.remove('bg-gray-400');
            radioAntenna.classList.add('bg-green-400'); // Signal Green

            radioAntennaTip.classList.remove('bg-red-600', 'border-red-800', 'shadow-[0_0_5px_rgba(220,38,38,0.8)]');
            radioAntennaTip.classList.add('bg-green-500', 'border-green-700', 'shadow-[0_0_15px_#22c55e]');

        } else {
            // Strangers: Retract Antenna
            radioAntenna.style.height = "24px"; // Short
            radioAntenna.classList.remove('bg-green-400');
            radioAntenna.classList.add('bg-gray-400');

            radioAntennaTip.classList.remove('bg-green-500', 'border-green-700', 'shadow-[0_0_15px_#22c55e]');
            radioAntennaTip.classList.add('bg-red-600', 'border-red-800', 'shadow-[0_0_5px_rgba(220,38,38,0.8)]');
        }

        // 3. BUTTON LOGIC (Get on same Channel)
        configureRadioButton(status, userId);
    }

    // 1. SELECT THE NEW BUTTON
    const rejectBtn = document.getElementById('reject-btn');
    const radioBtnText = document.getElementById('radio-btn-text');
    const dimensionControls = document.getElementById('dimension-controls'); // The container for 2 buttons
    const btnHawkins = document.getElementById('btn-hawkins');
    const btnUpsideDown = document.getElementById('btn-upsidedown');

    const statusHawkins = btnHawkins.querySelector('span:last-child'); // The "VACANT" text
    const statusUpside = btnUpsideDown.querySelector('span:last-child');
    

    function configureRadioButton(status, userId) {
        // Reset basic styles
        radioBtn.classList.remove('hidden');
        dimensionControls.classList.add('hidden');
        rejectBtn.onclick = null;
        rejectBtn.classList.add('hidden'); // Hide reject by default

        let safeFreq = currentFrequency;
        if (safeFreq === 'null' || safeFreq === 'None' || safeFreq === 'undefined') {
            safeFreq = null;
        }

        if (status === 0) {
            radioBtn.innerText = "BROADCAST SIGNAL"; // Send Request
            radioBtn.className = "w-full h-16 bg-red-900 text-red-200 font-bold tracking-widest uppercase hover:bg-red-800 border-b-4 border-red-950 active:border-b-0 active:translate-y-1 transition rounded-lg";
            radioBtn.onclick = function() {
                sendRequestSignal(userId);
            };
            // Add click event later for API call
        } 
        else if (status === 1) {
            radioBtn.innerText = "TUNING..."; // Pending
            radioBtn.className = "w-full h-16 bg-yellow-800 text-yellow-100 font-bold tracking-widest uppercase cursor-wait border-b-4 border-yellow-950 rounded-lg";
        }
        else if (status === 2) {
            // 1. Hide the main "Scan" button
            radioBtn.classList.add('hidden'); 
            
            // 2. Show the "Dimension Controls" container
            dimensionControls.classList.remove('hidden');

            // 3. Configure Hawkins Button
            fetch(`/api/status/${safeFreq}/`)
            .then(res => res.json())
            .then(data => {
                
                // --- HAWKINS LOGIC ---
                if (data.hawkins.occupied && !data.hawkins.is_me) {
                    // Case A: Someone else is there
                    btnHawkins.disabled = true;
                    btnHawkins.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                    statusHawkins.innerText = "OCCUPIED";
                    statusHawkins.classList.add('text-gray-500');
                } else {
                    // Case B: Empty OR It's me (allow re-entry)
                    btnHawkins.disabled = false;
                    btnHawkins.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
                    statusHawkins.innerText = "VACANT";
                    statusHawkins.classList.remove('text-gray-500');
                    
                    btnHawkins.onclick = () => {
                        window.location.href = `/wall/${safeFreq}/?theme=hawkins`;
                    };
                }

                // --- UPSIDE DOWN LOGIC ---
                if (data.upsidedown.occupied && !data.upsidedown.is_me) {
                    btnUpsideDown.disabled = true;
                    btnUpsideDown.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                    statusUpside.innerText = "OCCUPIED";
                    statusUpside.classList.add('text-gray-500');
                } else {
                    btnUpsideDown.disabled = false;
                    btnUpsideDown.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
                    statusUpside.innerText = "THE RIFT";
                    statusUpside.classList.remove('text-gray-500');
                    
                    btnUpsideDown.onclick = () => {
                        window.location.href = `/wall/${safeFreq}/?theme=upsidedown`;
                    };
                }
            });
        }
        else if (status === 3) {
            radioBtn.innerText = "Rejected";
            radioBtn.className = "w-full h-16 bg-gray-700 text-gray-500 cursor-not-allowed border-b-4 border-gray-900 rounded-lg";
        }
        else if (status === 5) {
            // A. Main Button = Accept
            radioBtnText.innerText = "COPY THAT (ACCEPT)"; 
            radioBtn.className = "relative w-full h-16 bg-gradient-to-b from-green-600 to-green-800 text-white animate-pulse rounded-lg shadow-[0_5px_0_#14532d] active:translate-y-[5px] active:shadow-none transition border-t border-green-500";
            radioBtn.onclick = () => handleRequest(userId, 'accept');

            // B. Show Reject Button
            rejectBtn.classList.remove('hidden');
            rejectBtn.onclick = () => handleRequest(userId, 'reject');
        }
    }

    function handleRequest(userId, action){
        const url = action === 'accept'
            ? `/api/accept-request/${userId}/`
            : `/api/reject-request/${userId}/`;

        fetch(url, {
            method:'POST',
            headers:{
                'X-CSRFToken':getCookie('csrftoken'),
                'Content-Type':'application/json'
            }
        })
        .then(res => response.json())
        .then(data => {
            if(data.status === 'success'){
                if(action === 'accept'){
                    updateRadio(radioName.innerText,data.frequency, parseInt(radioChannel.innerText), 2, userId);
                    document.getElementById('radio-antenna').style.height = '240px';
                }else{
                    updateRadio(radioName.innerText, data.frequency ,parseInt(radioChannel.innerText), 0, userId);
                }
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function sendRequestSignal(userId){
        const btn = document.getElementById('radio-btn');

        btn.innerText = "BROADCASTING...";
        btn.classList.add('cursor-wait');

        fetch(`/api/send-request/${userId}/`, {
            method:'POST',
            headers:{
                'X-CSRFToken':getCookie('csrftoken'),
                'Content-Type':'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === "success"){
                console.log("Signal Sent!")
                configureRadioButton(1,userId);

            }else{
                console.error("Signal Jammed:", data.message);
            }
        });
    }

    const wsScheme = window.location.protocol === 'https:'? 'wss':'ws';
    const radioSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/radio/'
    );
    radioSocket.onopen= function(e){
        console.log("Radio Connected.");
        fetchUsers('');

    };
    radioSocket.onmessage = function(e){
        const data = JSON.parse(e.data);
        console.log("Radio Signal Received: ", data)
        if (data.type === 'request_accepted') {
            // If I am currently looking at the person who accepted me
            if (currentSelectedId === data.accepter_id ) {
                // Update Radio to "Open Comms" instantly
                updateRadio(data.accepter_name, data.frequency, '??', 2, data.accepter_id);
                document.getElementById('radio-antenna').style.height = '240px';
                
                // Play a success sound?
            }
            if (currentSelectedId === data.requester_id ) {
                // Update Radio to "Open Comms" instantly
                updateRadio(data.requester_name,data.frequency, '??', 2, data.requester_id);
                document.getElementById('radio-antenna').style.height = '240px';
                
                // Play a success sound?
            }
            // Optional: Refresh the sidebar list to show them as friend
            fetchUsers(''); 
        }
        else if (data.type === 'incoming_request') {
             // If I am currently looking at the person who sent it
             if (currentSelectedId === data.sender_id) {
                updateRadio(data.sender_name,data.frequency, '??', 5, data.sender_id);
             }
             // Notify user visually (Red dot?)
        }

        else if (data.type === 'request_rejected') {
            if (currentSelectedId === data.rejecter_id) {
                updateRadio(radioName.innerText,data.frequency, '00', 3, data.rejecter_id);
            }
            if (currentSelectedId === data.requester_id) {
                updateRadio(radioName.innerText,data.frequency, '00', 3, data.requester_id);
            }
        }
    };

    radioSocket.onclose = function(e) {
        console.error('Radio link lost (Socket closed)');
    };
</script>
{% endblock %}